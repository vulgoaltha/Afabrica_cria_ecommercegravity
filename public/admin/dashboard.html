<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Admin</title>
    <script type="importmap">
    {
        "imports": {
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/storage": "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js"
        }
    }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body class="bg-gray-900 text-white font-sans antialiased">
    <div class="flex h-screen overflow-hidden">

        <!-- Sidebar -->
        <aside class="w-64 bg-gray-800 border-r border-gray-700 hidden md:flex flex-col">
            <div class="p-6 border-b border-gray-700">
                <h1 class="text-2xl font-bold text-yellow-500">ADMIN</h1>
            </div>
            <nav class="flex-grow p-4 space-y-2">
                <a href="dashboard.html"
                    class="flex items-center gap-3 px-4 py-3 bg-gray-700 text-white rounded-lg transition">
                    <i class="fas fa-chart-line"></i> Dashboard
                </a>
                <a href="pedidos.html"
                    class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-700 hover:text-white rounded-lg transition">
                    <i class="fas fa-box"></i> Pedidos
                </a>
                <a href="produtos.html"
                    class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-700 hover:text-white rounded-lg transition">
                    <i class="fas fa-tshirt"></i> Produtos
                </a>
                <a href="reviews.html"
                    class="flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-700 hover:text-white rounded-lg transition">
                    <i class="fas fa-star"></i> Avaliações
                </a>
            </nav>
            <div class="p-4 border-t border-gray-700">
                <button id="logout-btn"
                    class="flex items-center gap-3 px-4 py-3 text-red-400 hover:bg-gray-700 hover:text-red-300 rounded-lg w-full transition">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="bg-gray-800 h-16 border-b border-gray-700 flex items-center justify-between px-6">
                <div class="md:hidden">
                    <button class="text-gray-300 hover:text-white"><i class="fas fa-bars text-xl"></i></button>
                </div>
                <div class="ml-auto flex items-center gap-4">
                    <span id="user-display" class="text-sm text-gray-400">Carregando...</span>
                    <div
                        class="w-8 h-8 rounded-full bg-yellow-500 flex items-center justify-center text-black font-bold">
                        A</div>
                </div>
            </header>

            <!-- Dashboard Content -->
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-900 p-6">
                <h2 class="text-2xl font-bold mb-6">Visão Geral</h2>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <!-- Faturamento -->
                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-gray-400 text-sm uppercase">Faturamento (Mês)</h3>
                            <span class="p-2 bg-green-500/10 text-green-500 rounded-lg"><i
                                    class="fas fa-dollar-sign"></i></span>
                        </div>
                        <p class="text-2xl font-bold" id="total-revenue">R$ 0,00</p>
                        <span class="text-xs text-green-400">+12% vs mês anterior</span>
                    </div>

                    <!-- Pedidos -->
                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-gray-400 text-sm uppercase">Novos Pedidos</h3>
                            <span class="p-2 bg-blue-500/10 text-blue-500 rounded-lg"><i
                                    class="fas fa-shopping-bag"></i></span>
                        </div>
                        <p class="text-2xl font-bold" id="total-orders">0</p>
                    </div>

                    <!-- Pendentes -->
                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-gray-400 text-sm uppercase">Aguardando Pagamento</h3>
                            <span class="p-2 bg-yellow-500/10 text-yellow-500 rounded-lg"><i
                                    class="fas fa-clock"></i></span>
                        </div>
                        <p class="text-2xl font-bold" id="pending-orders">0</p>
                    </div>

                    <!-- Reviews -->
                    <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-gray-400 text-sm uppercase">Avaliações Pendentes</h3>
                            <span class="p-2 bg-purple-500/10 text-purple-500 rounded-lg"><i
                                    class="fas fa-star-half-alt"></i></span>
                        </div>
                        <p class="text-2xl font-bold" id="pending-reviews">0</p>
                    </div>
                </div>

                <!-- Recent Orders Table -->
                <div class="bg-gray-800 rounded-xl border border-gray-700 shadow-lg overflow-hidden">
                    <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                        <h3 class="font-bold text-lg">Últimos Pedidos</h3>
                        <a href="pedidos.html" class="text-sm text-yellow-500 hover:underline">Ver todos</a>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700/50 text-gray-400 text-xs uppercase">
                                <tr>
                                    <th class="px-6 py-4">ID</th>
                                    <th class="px-6 py-4">Cliente</th>
                                    <th class="px-6 py-4">Data</th>
                                    <th class="px-6 py-4">Valor</th>
                                    <th class="px-6 py-4">Status</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-700" id="recent-orders-body">
                                <tr>
                                    <td colspan="5" class="px-6 py-8 text-center text-gray-500">Carregando pedidos...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        import { logout, protegerAdmin } from '../js/auth.js';
        import { db } from '../js/firebase.js';
        import { collection, query, orderBy, limit, getDocs, where } from "firebase/firestore";

        // Auth Check
        protegerAdmin(async (user) => {
            document.getElementById('user-display').textContent = user.email;
            loadDashboardData();
        });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', async () => {
            await logout();
            window.location.href = 'login.html';
        });

        async function loadDashboardData() {
            try {
                // Carregar pedidos recentes
                const ordersRef = collection(db, "orders");
                const q = query(ordersRef, orderBy("createdAt", "desc"), limit(5));
                const querySnapshot = await getDocs(q);

                const tbody = document.getElementById('recent-orders-body');
                tbody.innerHTML = '';

                let total = 0;
                let count = 0;

                if (querySnapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">Nenhum pedido encontrado.</td></tr>';
                } else {
                    querySnapshot.forEach((doc) => {
                        const order = doc.data();
                        count++;
                        // Simplificando total visual
                        // Em um app real, faríamos query de agregação ou cloud function

                        const date = order.createdAt?.toDate ? order.createdAt.toDate().toLocaleDateString('pt-BR') : 'N/A';

                        const tr = document.createElement('tr');
                        tr.className = "hover:bg-gray-700/50 transition";
                        tr.innerHTML = `
                            <td class="px-6 py-4 font-mono text-sm text-gray-400">#${doc.id.slice(0, 6)}</td>
                            <td class="px-6 py-4 font-medium">${order.customerName || 'Cliente'}</td>
                            <td class="px-6 py-4 text-sm text-gray-400">${date}</td>
                            <td class="px-6 py-4 font-medium text-green-400">R$ ${order.total?.toFixed(2) || '0.00'}</td>
                            <td class="px-6 py-4">
                                <span class="px-2 py-1 text-xs rounded bg-gray-700 text-white border border-gray-600">
                                    ${order.status || 'Pendente'}
                                </span>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }

                // Atualizar stats (simulado/query real simples)
                document.getElementById('total-orders').textContent = count; // Apenas dos recentes por enquanto

                // Para contadores reais precisa de count() query support ou ler todos (cuidado com leitura)

            } catch (error) {
                console.error("Erro ao carregar dashboard:", error);
            }
        }
    </script>
</body>

</html>